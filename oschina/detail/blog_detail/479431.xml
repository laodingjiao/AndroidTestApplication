<?xml version="1.0" encoding="UTF-8"?><oschina>
	<blog>
								<id>479431</id>
		<title><![CDATA[Sql缓存依赖]]></title>
		<url><![CDATA[http://my.oschina.net/u/200350/blog/479431]]></url>
		<where><![CDATA[MongoDB]]></where>
		<commentCount>0</commentCount>
		<body><![CDATA[<style type='text/css'>pre {white-space:pre-wrap;word-wrap:break-word;}</style><h1><span style="font-family: 'Microsoft YaHei';">Sql缓存依赖主要分为两种：</span></h1> 
<p><span style="font-family: 'Microsoft YaHei';"><span style="white-space: pre;"></span><span style="background-color: rgb(204, 255, 255);"><span style="font-size: 18px;">1.轮询模式(poll model)</span></span></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span><span style="background-color: rgb(204, 255, 255);">2.推模式(push model)</span></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>今天先讲解第一种模式：轮询</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>要使用sql轮询模式，得做三方面的工作：</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>1.对数据库启用缓存依赖</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>2.对一个或多个表启用缓存依赖</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>3.在web.config中配置应用程序</span></p> 
<p><span style="font-family: 'Microsoft YaHei';"><span style="white-space: pre;"></span><strong><span style="font-size: 32px;">一.对数据启用缓存依赖</span></strong></span></p> 
<p><span style="font-family: 'Microsoft YaHei';"><span style="white-space: pre;"></span><span style="font-size: 18px;">在visual studio command prompt中执行以下命令</span></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>aspnet_regsql -C "Data Souce=localhost;Integrated Security=True;Initial Catalog=SqlTest" -ed</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>注释：aspnet_regsql是命令行工具 本命令表示启用SqlTest数据库缓存依赖</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="http://192.168.79.254:8080/oschina/images/uploads/img/201507/16175310_121x.png" alt=""><br></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">当执行该命令后，将会在数据库SqlTest中创建表：AspNet_SqlCacheTablesForChangeNotification，如图：</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="http://192.168.79.254:8080/oschina/images/uploads/img/201507/16175310_KGQu.png" alt=""><br></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">tableName：记录被缓存的表</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">notificationCreated：记录缓存被创建的时间</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">changeId：计数器，当表数据修改后，自动增加1</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">同事创建5个存储过程：</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">AspNet_SqlCachePollingStoredProcedure<br></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">AspNet_SqlCacheQueryRegisteredTablesStoredProcedure<br></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">AspNet_SqlCacheRegisterTableStoredProcedure<br></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">AspNet_SqlCacheUnRegisterTableStoredProcedure<br></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">AspNet_SqlCacheUpdateChangeIdStoredProcedure<br></span></p> 
<p><span style="font-family: 'Microsoft YaHei';"><span style="white-space: pre;"></span><strong><span style="font-size: 32px;">二.对数据表启用缓存依赖</span></strong></span></p> 
<p><span style="font-family: 'Microsoft YaHei';"><span style="white-space: pre;"></span><span style="font-size: 18px;">在visual studio command prompt中执行以下命令</span></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>aspnet_regsql -C "Data Souce=localhost;Integrated Security=True;Initial Catalog=Pubs" -et -t<span style="color: rgb(0, 153, 0);">&nbsp;Customers</span></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>注释：对Customers表启用缓存依赖</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="http://192.168.79.254:8080/oschina/images/uploads/img/201507/16175310_nyxf.png" alt=""><br></span></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">当执行该命令后，将在数据库表AspNet_SqlCacheTablesForChangeNotification中添加一条记录，如图：</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><img src="http://192.168.79.254:8080/oschina/images/uploads/img/201507/16175310_UZTN.png" alt=""><br></span></p>
<p><strong><span style="font-family: 'Microsoft YaHei';"><span style="white-space: pre;"></span><span style="font-size: 32px;">三.配置应用程序</span></span></strong></p> 
<p><span style="color: rgb(51, 51, 51); font-family: Arial; font-size: 14px; line-height: 26px; white-space: pre; background-color: rgb(255, 255, 255);"><span style="font-family: 'Microsoft YaHei';"></span></span></p> 
<p><strong>[html]</strong>&nbsp;<a href="http://blog.csdn.net/wangjunbianchengcesh/article/details/7703923#" rel="nofollow">view plain</a><a href="http://blog.csdn.net/wangjunbianchengcesh/article/details/7703923#" rel="nofollow">copy</a></p> 
<ol> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;"><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">caching</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">sqlCacheDependency</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">enabled</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"true"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">pollTime</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"1000"</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">databases</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">add</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">name</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"mydatabase"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">connectionStringName</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"pubsConnectionstring"</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">/&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">databases</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">sqlCacheDependency</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">caching</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
</ol> 
<p><span style="font-family: 'Microsoft YaHei';"><span style="white-space: pre;"></span><span style="font-size: 18px;">注释：pollTime设置为1000ms，意思是应用程序按照1s的频率进行轮询，如果数据库表Customers数据被修改，则缓存在1m内失效，重新加载新的数据，然后缓存，知道数据被再次修改，检测数据库表的变化，connectionStringName被设置为要对哪一个数据库进行轮询的数据库连接字符串</span></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;"><span style="white-space: pre;"></span>此时已经对sql轮询模式已经设置完毕。</span></p> 
<p><span style="font-family: 'Microsoft YaHei';"><strong><span style="font-size: 32px;">四.验证</span></strong></span></p> 
<p><span style="font-size: 18px;"><span style="font-family: 'Microsoft YaHei';">1.建立页面default.aspx</span></span></p> 
<p><span style="font-size: 18px;"><span style="font-family: 'Microsoft YaHei';">2.设置缓存：</span></span></p> 
<p><span style="font-size: 18px;"><span style="font-family: 'Microsoft YaHei';"><span style="white-space: pre;"></span></span></span></p> 
<p><strong>[html]</strong>&nbsp;<a href="http://blog.csdn.net/wangjunbianchengcesh/article/details/7703923#" rel="nofollow">view plain</a><a href="http://blog.csdn.net/wangjunbianchengcesh/article/details/7703923#" rel="nofollow">copy</a></p> 
<ol> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;"><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">%@&nbsp;OutPutCache&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">Duration</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"20"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">VaryByParam</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"none"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">SqlDependency</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"mydatabase:Customers"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;%</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
</ol> 
<p><span style="color: rgb(51, 51, 51); line-height: 26px; font-family: 'Microsoft YaHei'; font-size: 18px; background-color: rgb(255, 255, 255);">注释：本页面缓存20秒，mydatabase为配置文件中设置sql缓存的项的name值，Customers是要被缓存的表</span><span style="color: rgb(51, 51, 51); line-height: 26px; font-family: 'Microsoft YaHei'; font-size: 18px; background-color: rgb(255, 255, 255);">3.页面测试代码如下：</span></p> 
<p><strong>[html]</strong>&nbsp;<a href="http://blog.csdn.net/wangjunbianchengcesh/article/details/7703923#" rel="nofollow">view plain</a><a href="http://blog.csdn.net/wangjunbianchengcesh/article/details/7703923#" rel="nofollow">copy</a></p> 
<ol> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;"><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">html</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">xmlns</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"http://www.w3.org/1999/xhtml"</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;"><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">head</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">runat</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"server"</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">title</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">title</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;"><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">head</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;"><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">body</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">form</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">id</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"form1"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">runat</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"server"</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">%=&nbsp;DateTime.Now.ToString("T")&nbsp;%</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">div</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">asp:GridView</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">runat</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"server"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">DataSourceID</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"srcCustomers"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">/&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">asp:SqlDataSource</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">runat</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"server"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">ID</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"srcCustomers"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">ConnectionString</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"&lt;%$&nbsp;ConnectionStrings:SqlTestConnstring&nbsp;%&gt;"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: red; background-color: inherit;">SelectCommand</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">=</span><span style="margin: 0px; padding: 0px; border: none; color: blue; background-color: inherit;">"SELECT&nbsp;*&nbsp;FROM&nbsp;[SqlTest].[dbo].[Customers]"</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">/&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">div</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;">&nbsp;&nbsp;&nbsp;&nbsp;<span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">form</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;"><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">body</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
 <li><p><span style="margin: 0px; padding: 0px; border: none; color: black; background-color: inherit;"><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&lt;/</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">html</span><span style="margin: 0px; padding: 0px; border: none; color: rgb(153, 51, 0); font-weight: bold; background-color: inherit;">&gt;</span><span style="margin: 0px; padding: 0px; border: none; background-color: inherit;">&nbsp;&nbsp;</span></span></p></li> 
</ol> 
<p><br></p> 
<pre><br></pre> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">注意：对属性SqlDependency如果要设置多个表的话，形势如下：</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">SqlDependency="mydatabase:Customers;mydatabase:Products"</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">3.运行效果</span></p> 
<p><img src="http://192.168.79.254:8080/oschina/images/uploads/img/201507/16175311_s559.png" alt=""></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">如果在20s内刷新页面，则时间不会改变，20s后时间被更新，现在我们修改下customers的数据，然后刷新页面，效果如下：</span></p> 
<p><img src="http://192.168.79.254:8080/oschina/images/uploads/img/201507/16175311_CwI3.png" alt=""></p>
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">时间被修改，页面展示的Tom也被更新为fred,当数据库的数据修改后，缓存将在1s(配置文件中的PollTime值)被失效。</span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">原理解析：轮询Sql缓存依赖是最灵活的Sql缓存依赖类型，所以推荐使用轮询sql缓存依赖。轮询模式使用的是数据库触发器，当表数据被修改时，触发器被触发，则表AspNet_SqlCacheTablesForChangeNotification中的记录ChangeId字段自定加1。</span></p> 
<p><span style="font-size: 18px;"><span style="font-family: 'Microsoft YaHei';">asp.net framework 使用一个后台线程，用来定期轮询数据库表的修改情况，如果有修改，则依赖于数据库表的缓存项目从缓存中移除。应用程序每次在查询数据时现检测表AspNet_SqlCacheTablesForChangeNotification的记录有没有被修改，如果没有修改则使用缓存中的数据，如果被修改则重新获取数据然后放入缓存中。</span></span></p> 
<p><span style="font-size: 18px;"><span style="font-family: 'Microsoft YaHei';"></span></span></p> 
<p><span style="font-family: 'Microsoft YaHei'; font-size: 18px;">好了，今天就到这儿哦，如有错误，请指正！</span></p> 
<p><br></p>]]></body>
		<author><![CDATA[江南飞]]></author>
		<authorid>200350</authorid>
		<documentType>0</documentType>
        <pubDate>2015-07-16 17:53:10</pubDate>
		<favorite>0</favorite>
			</blog>
</oschina>